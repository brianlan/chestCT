import sys
from collections import OrderedDict

import pytest
import numpy as np


sys.argv = [
    'x',
    '--objinfo-path',
    'x',
    '--meta-dir',
    'x',
    '--output-file-path',
    'x'
]


def test_match_detections_into_groups():
    from merge_pred_results import match_detections_into_groups
    slice_partition = OrderedDict({
        "10": np.array([[1., 334.2, 333.6, 372.5, 369.9, 0.1262],
                        [1., 306.6, 291.3, 366.7, 377.6, 0.0628]]),
        "11": np.array([[1., 301.5, 311.4, 342.7, 353.8, 0.2658],
                        [1., 332.3, 332.6, 373.4, 369.8, 0.1116]]),
        "12": np.array([[1., 300.2, 308.1, 337., 355.2, 0.726],
                        [1., 296.6, 320.7, 318.2, 349.6, 0.0591],
                        [1., 290., 272.9, 400.8, 375.1, 0.0567]]),
        "13": np.array([[1., 296., 308.9, 335.9, 356.9, 0.6647]]),
        "14": np.array([[1., 186.5, 146.5, 222., 180.6, 0.056],
                        [1., 321.9, 286.6, 413.2, 356., 0.1328]]),
        "15": np.array([[1., 188.8, 147.7, 222.4, 182.2, 0.2534],
                        [1., 329.5, 284.4, 410.9, 359.1, 0.5493]]),
        "16": np.array([[1., 191., 146.8, 224.1, 181.6, 0.1247],
                        [1., 329.1, 282., 409.6, 356.6, 0.2876]]),
        "17": np.array([[1., 387.7, 246.1, 410.6, 267.3, 0.1275],
                        [1., 190.9, 150., 225.5, 190.8, 0.0503],
                        [1., 323.9, 261.7, 407.3, 346.5, 0.0852]]),
        "18": np.array([[1., 385.7, 246.3, 409.9, 268.1, 0.143],
                        [1., 304., 280.7, 338.6, 320.1, 0.0606],
                        [1., 302.4, 234.8, 412., 347.6, 0.0859]]),
        "19": np.array([[1., 376.9, 248.9, 410.6, 284.4, 0.0601],
                        [1., 310.7, 250.7, 406.8, 316.5, 0.1501]]),
        "20": np.array([[1., 343.9, 242.4, 410., 309.8, 0.1443]]),
        "21": np.array([[1., 346.5, 240., 407.3, 337.2, 0.3886],
                        [2., 277.3, 245.1, 297.2, 265.1, 0.0701],
                        [3., 277.5, 246.1, 297.3, 264.5, 0.1325]]),
        "22": np.array([[1., 365.5, 252.5, 406.2, 298.3, 0.0834],
                        [1., 335.6, 255.2, 406.5, 348.3, 0.4653],
                        [3., 277.6, 246.2, 297.5, 264.7, 0.1503]]),
        "23": np.array([[1., 223.3, 149.6, 255.4, 190.7, 0.2933],
                        [1., 365.9, 253.3, 406.7, 297.3, 0.1004],
                        [1., 334.1, 256.4, 404., 349.4, 0.5352]]),
        "24": np.array([[1., 224.4, 149.1, 257.8, 192.1, 0.552],
                        [1., 366.1, 254.6, 407.5, 295.9, 0.1367],
                        [1., 386.8, 261.7, 409.5, 283.6, 0.0826],
                        [1., 329.9, 255.1, 403.5, 349.9, 0.4196]]),
        "25": np.array([[1., 323.7, 311.9, 372.9, 353.1, 0.0902],
                        [1., 364.6, 254., 407.9, 292., 0.1936],
                        [1., 386.1, 261.5, 409.8, 283.2, 0.0529],
                        [1., 307., 239.5, 412.9, 357., 0.3813]]),
        "26": np.array([[1., 361.2, 251.7, 407.1, 293.4, 0.3898],
                        [1., 304., 238.8, 416.7, 354.8, 0.2841]]),
        "27": np.array([[1., 362.1, 250.2, 405.6, 292.8, 0.4389],
                        [1., 232.5, 149.1, 273.4, 196.1, 0.1167],
                        [1., 331.3, 244.7, 409.2, 325.8, 0.1273]]),
        "28": np.array([[1., 231.4, 148.8, 274.1, 200.5, 0.4956],
                        [1., 362.4, 250.1, 404.4, 295.2, 0.4509]]),
        "29": np.array([[1., 364.5, 251.7, 404.1, 295.7, 0.4218],
                        [1., 229.2, 149., 276.1, 201.5, 0.4381],
                        [1., 203.4, 129.6, 296.3, 233.8, 0.1206]]),
        "30": np.array([[1., 234.9, 148.4, 275.7, 197.4, 0.5958],
                        [1., 365.1, 251.8, 405.6, 294.7, 0.3171]]),
        "31": np.array([[1., 237.4, 148.6, 277.3, 192.6, 0.1917]]),
        "32": np.array([[1., 250.7, 146.6, 287.4, 179.1, 0.105]])})

    lesions_3d = match_detections_into_groups(slice_partition)

    assert lesions_3d == [[[10, 1., 306.6, 291.3, 366.7, 377.6, 0.0628], ],

                          [[10, 1., 334.2, 333.6, 372.5, 369.9, 0.1262],
                           [11, 1., 332.3, 332.6, 373.4, 369.8, 0.1116], ],

                          [[12, 1., 296.6, 320.7, 318.2, 349.6, 0.0591], ],

                          [[12, 1., 290., 272.9, 400.8, 375.1, 0.0567], ],

                          [[11, 1., 301.5, 311.4, 342.7, 353.8, 0.2658],
                           [12, 1., 300.2, 308.1, 337., 355.2, 0.726],
                           [13, 1., 296., 308.9, 335.9, 356.9, 0.6647], ],

                          [[14, 1., 186.5, 146.5, 222., 180.6, 0.056],
                           [15, 1., 188.8, 147.7, 222.4, 182.2, 0.2534],
                           [16, 1., 191., 146.8, 224.1, 181.6, 0.1247],
                           [17, 1., 190.9, 150., 225.5, 190.8, 0.0503], ],

                          [[14, 1., 321.9, 286.6, 413.2, 356., 0.1328],
                           [15, 1., 329.5, 284.4, 410.9, 359.1, 0.5493],
                           [16, 1., 329.1, 282., 409.6, 356.6, 0.2876],
                           [17, 1., 323.9, 261.7, 407.3, 346.5, 0.0852], ],

                          [[18, 1., 304., 280.7, 338.6, 320.1, 0.0606], ],

                          [[18, 1., 302.4, 234.8, 412., 347.6, 0.0859], ],

                          [[17, 1., 387.7, 246.1, 410.6, 267.3, 0.1275],
                           [18, 1., 385.7, 246.3, 409.9, 268.1, 0.143],
                           [19, 1., 376.9, 248.9, 410.6, 284.4, 0.0601], ],

                          [[19, 1., 310.7, 250.7, 406.8, 316.5, 0.1501], ],

                          [[20, 1., 343.9, 242.4, 410., 309.8, 0.1443],
                           [21, 1., 346.5, 240., 407.3, 337.2, 0.3886], ],

                          [[21, 2., 277.3, 245.1, 297.2, 265.1, 0.0701], ],

                          [[21, 3., 277.5, 246.1, 297.3, 264.5, 0.1325],
                           [22, 3., 277.6, 246.2, 297.5, 264.7, 0.1503], ],

                          [[23, 1., 223.3, 149.6, 255.4, 190.7, 0.2933],
                           [24, 1., 224.4, 149.1, 257.8, 192.1, 0.552], ],

                          [[24, 1., 386.8, 261.7, 409.5, 283.6, 0.0826],
                           [25, 1., 386.1, 261.5, 409.8, 283.2, 0.0529], ],

                          [[25, 1., 323.7, 311.9, 372.9, 353.1, 0.0902], ],

                          [[22, 1., 335.6, 255.2, 406.5, 348.3, 0.4653],
                           [23, 1., 334.1, 256.4, 404., 349.4, 0.5352],
                           [24, 1., 329.9, 255.1, 403.5, 349.9, 0.4196],
                           [25, 1., 307., 239.5, 412.9, 357., 0.3813],
                           [26, 1., 304., 238.8, 416.7, 354.8, 0.2841], ],

                          [[27, 1., 331.3, 244.7, 409.2, 325.8, 0.1273], ],

                          [[29, 1., 203.4, 129.6, 296.3, 233.8, 0.1206], ],

                          [[22, 1., 365.5, 252.5, 406.2, 298.3, 0.0834],
                           [23, 1., 365.9, 253.3, 406.7, 297.3, 0.1004],
                           [24, 1., 366.1, 254.6, 407.5, 295.9, 0.1367],
                           [25, 1., 364.6, 254., 407.9, 292., 0.1936],
                           [26, 1., 361.2, 251.7, 407.1, 293.4, 0.3898],
                           [27, 1., 362.1, 250.2, 405.6, 292.8, 0.4389],
                           [28, 1., 362.4, 250.1, 404.4, 295.2, 0.4509],
                           [29, 1., 364.5, 251.7, 404.1, 295.7, 0.4218],
                           [30, 1., 365.1, 251.8, 405.6, 294.7, 0.3171], ],

                          [[27, 1., 232.5, 149.1, 273.4, 196.1, 0.1167],
                           [28, 1., 231.4, 148.8, 274.1, 200.5, 0.4956],
                           [29, 1., 229.2, 149., 276.1, 201.5, 0.4381],
                           [30, 1., 234.9, 148.4, 275.7, 197.4, 0.5958],
                           [31, 1., 237.4, 148.6, 277.3, 192.6, 0.1917],
                           [32, 1., 250.7, 146.6, 287.4, 179.1, 0.105], ], ]
